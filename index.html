<!DOCTYPE html>
<html>
<head>
  <title>Interactive Leaflet Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <style>
    #map {
      height: 100vh;
    }
    body {
      height: 100%;
      margin: 0%;
    }
  </style>
</head>
<body>
  

<div id="map"></div>

<!-- Leaflet JS -->
 
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-database-compat.js"></script>


<script>
const firebaseConfig = {
  apiKey: "AIzaSyCaFYceUq0CnWrM4xskn4GVAbGKdcZOfas",
  authDomain: "walking1-10369.firebaseapp.com",
  databaseURL: "https://walking1-10369-default-rtdb.firebaseio.com", // <-- Add this line!
  projectId: "walking1-10369",
  storageBucket: "walking1-10369.appspot.com",
  messagingSenderId: "87191712245",
  appId: "1:87191712245:web:667131a0783c49235cb0bc",
  measurementId: "G-PG4MG1TQT3"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();



  // Step 1: Initialize map
  const map = L.map('map').setView([52.5200, 13.4050], 13); // Berlin coordinates 

  let routingControl;

function routeTo(lat, lng) {
  if (routingControl) {
    map.removeControl(routingControl);
  }

  routingControl = L.Routing.control({
    waypoints: [
      userMarker ? L.latLng(userMarker.getLatLng()) : L.latLng(52.52, 13.405), // fallback if not ready
  
      L.latLng(lat, lng)
    ],
    routeWhileDragging: false
  }).addTo(map);
  }


  // Step 2: Add OpenStreetMap tile layer
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // ... your marker code ...
  const fixedPoints = [
  { name: "BrewDog", lat: 52.4381957, lng: 13.3681961 },
  { name: "NahKauf", lat: 52.4467165, lng: 13.3717101 },
  { name: "ARSLAN DÃ–NER", lat: 52.4465391, lng:13.3718895  }
  
];

fixedPoints.forEach(point => {
  const marker = L.marker
  ([point.lat, point.lng])
    .addTo(map)
    .bindPopup(`<strong>${point.name}</strong><br/><button onclick="routeTo(${point.lat}, ${point.lng})">Navigate</button>`);
});


  // --- Real-time location sharing ---
  let userMarker;
  const userId = 'user_' + Math.random().toString(36).substr(2, 9);
  const userName = prompt("Enter your name:");
  const userAvatar = "https://via.placeholder.com/40"; // You can customize this

  navigator.geolocation.watchPosition(
  position => {
    const lat = position.coords.latitude;
    const lng = position.coords.longitude;

    // Update your location in Firebase
  db.ref('locations/' + userId).set({ 
  lat, 
  lng, 
  name: userName, 
  avatar: userAvatar 
});
  

    // Show or update your marker
    const latlng = L.latLng(lat, lng);
    if (!userMarker) {
    userMarker = L.circleMarker(latlng, {
  color: 'blue',
  radius: 8
})
  .addTo(map).bindPopup("You are here").openPopup();
      map.setView(latlng, 16);
    } else {
      userMarker.setLatLng(latlng);
    }
  },
  error => {
    alert("Error getting location: " + error.message);
  },
  {
    enableHighAccuracy: true,
    maximumAge: 0,
    timeout: 10000
  }
 );
 

  // Listen for all users' locations
  
 
   const otherMarkers = {};

db.ref('locations').on('value', snapshot => {
  const locations = snapshot.val();
  for (const id in locations) {
    if (id === userId) continue;
    const loc = locations[id];

   const name = loc.name || "Anonymous";
const avatar = loc.avatar || "https://via.placeholder.com/40";

// Optional: filter to only track specific users


const popupContent = `
  <div style="text-align:center;">
    <img src="${avatar}" width="40" height="40" style="border-radius:50%;" /><br/>
    <strong>${name}</strong>
  </div>
`;

if (otherMarkers[id]) {
  otherMarkers[id].setLatLng([loc.lat, loc.lng]);
  otherMarkers[id].bindPopup(popupContent);
} else {
  otherMarkers[id] = L.circleMarker([loc.lat, loc.lng], {
    color: 'red',
    radius: 6
  }).addTo(map).bindPopup(popupContent);
}

  }
 // Clean up markers of users who are no longer in the database
for (const id in otherMarkers) {
  if (!locations[id]) {
    map.removeLayer(otherMarkers[id]);
    delete otherMarkers[id];
  }
}
 
});
map.on('click', function(e) {
  const destLatLng = e.latlng;
  if (confirm("Navigate to this point?")) {
    routeTo(destLatLng.lat, destLatLng.lng);
  }
});


</script>
</body>
</html>

